<script>
  // TODO: Dán 2 link CSV thật của bạn vào đây
  const SHEET_CSV_URLS = [
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vTCPe3HvdHP1tHFEhmMQn3IwVLM2pTZzt6CVweXZgn3b3Yz60RO9Z7z5GPMFRdBXsS9hPpNM_gJpiOX/pub?output=csv",
    "https://docs.google.com/spreadsheets/d/ID_SHEET_2/export?format=csv&gid=0"
  ];

  let phoneSet = new Set();
  let isLoaded = false;

  const loadStatusEl = document.getElementById("loadStatus");
  const resultBox = document.getElementById("resultBox");
  const phoneInput = document.getElementById("phoneInput");
  const checkBtn = document.getElementById("checkBtn");

  // Chuẩn hóa số điện thoại
  function normalizePhone(raw) {
    if (!raw) return "";
    let s = String(raw).trim();

    // +84xxxx → 0xxxx
    if (s.startsWith("+84")) {
      s = "0" + s.slice(3);
    }

    // bỏ mọi ký tự không phải số
    s = s.replace(/\D/g, "");

    return s;
  }

  // Tải và xử lý 1 sheet CSV
  async function loadOneSheet(url) {
    const res = await fetch(url);
    if (!res.ok) throw new Error("Không tải được CSV: " + url);

    const text = await res.text();
    const lines = text.split(/\r?\n/);

    for (let i = 1; i < lines.length; i++) {
      const line = lines[i].trim();
      if (!line) continue;

      const cols = line.split(",");

      // quét tất cả cột
      for (let j = 0; j < cols.length; j++) {
        const cellRaw = cols[j].trim();
        if (!cellRaw) continue;

        const normalized = normalizePhone(cellRaw);
        if (normalized) {
          phoneSet.add(normalized);
        }
      }
    }
  }

  // Tải dữ liệu từ nhiều sheet
  async function loadAllSheets() {
    try {
      loadStatusEl.textContent = "Đang tải dữ liệu từ nhiều sheet...";

      for (const url of SHEET_CSV_URLS) {
        await loadOneSheet(url);
      }

      isLoaded = true;
      loadStatusEl.textContent =
        `Đã tải tổng cộng ${phoneSet.size} số điện thoại từ nhiều sheet.`;

    } catch (err) {
      console.error(err);
      loadStatusEl.textContent = "Lỗi khi tải dữ liệu từ sheet.";
      loadStatusEl.classList.add("error");
    }
  }

  function showResult(found, inputRaw) {
    const normalized = normalizePhone(inputRaw);
    if (!normalized) {
      resultBox.style.display = "block";
      resultBox.className = "result not-ok";
      resultBox.textContent = "请输入要查询的电话号码.";
      return;
    }

    resultBox.style.display = "block";
    if (found) {
      resultBox.className = "result ok";
      resultBox.textContent =
        `✅ 电话号码 ${inputRaw} (电话号码: ${normalized}) 在列表中。`;
    } else {
      resultBox.className = "result not-ok";
      resultBox.textContent =
        `❌ 电话号码 ${inputRaw} (chuẩn hóa: ${normalized}) 不在列表中。`;
    }
  }

  function handleCheck() {
    if (!isLoaded) {
      alert("Dữ liệu đang tải, vui lòng chờ chút.");
      return;
    }

    const value = phoneInput.value;
    const normalized = normalizePhone(value);

    const found = phoneSet.has(normalized);
    showResult(found, value);
  }

  checkBtn.addEventListener("click", handleCheck);
  phoneInput.addEventListener("keyup", e => {
    if (e.key === "Enter") handleCheck();
  });

  // Bắt đầu tải 2 sheet khi mở trang
  loadAllSheets();
</script>
